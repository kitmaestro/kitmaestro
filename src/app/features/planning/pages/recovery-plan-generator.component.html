<div style="display: flex; align-items: center; margin-bottom: 16px; margin-top: 16px; justify-content: space-between;">
  <h2>Generador de Planes de Recuperación</h2>
</div>

<mat-stepper linear #stepper>
  <mat-step [stepControl]="generatorForm">
    <form [formGroup]="generatorForm" style="padding-top: 16px">
      <ng-template matStepLabel>Información General</ng-template>
      <div class="cols-2">
        <mat-form-field appearance="outline">
          <mat-label>Sección</mat-label>
          <mat-select formControlName="classSection" required>
            <mat-option *ngFor="let section of classSections" [value]="section._id">
              {{ section.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Asignatura</mat-label>
          <mat-select formControlName="subject" required>
            <mat-option *ngFor="let subject of subjects" [value]="subject">
              {{ subject | pretify }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Período</mat-label>
          <mat-select formControlName="period" required>
            <mat-option *ngFor="let period of periods" [value]="period">
              {{ period | uppercase }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Estudiantes</mat-label>
          <mat-select formControlName="students" multiple required>
            <mat-option *ngFor="let student of students$ | async" [value]="student._id">
              {{ student.firstName }} {{ student.lastName }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline">
        <mat-label>Tipo de Diagnóstico</mat-label>
        <mat-select formControlName="diagnosticType" required>
          <mat-option *ngFor="let type of diagnosticTypes" [value]="type">
            {{ type }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field *ngIf="generatorForm.value.diagnosticType === 'Otra'" appearance="outline">
        <mat-label>Diagnóstico Personalizado</mat-label>
        <textarea matInput formControlName="diagnostic"></textarea>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Indicadores de Logro</mat-label>
        <mat-select formControlName="achievementIndicators" multiple>
          <ng-container *ngFor="let competence of competences">
            <mat-option *ngFor="let criterion of competence.criteria" [value]="criterion">
              {{ criterion }}
            </mat-option>
          </ng-container>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Actores Involucrados</mat-label>
        <mat-select formControlName="actors" multiple>
          <mat-option *ngFor="let actor of actors" [value]="actor">
            {{ actor }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Notas Adicionales</mat-label>
        <textarea matInput formControlName="notes"></textarea>
      </mat-form-field>

      <div style="text-align: end">
        <button mat-flat-button color="primary" (click)="generate()" [disabled]="generatorForm.invalid || generating">
          <span *ngIf="!generating">{{ generatedPlan ? 'Regenerar' : 'Generar' }}</span>
          <span *ngIf="generating">Generando...</span>
        </button>
      </div>
    </form>
  </mat-step>

  <mat-step *ngIf="generatedPlan">
    <ng-template matStepLabel>Previsualización</ng-template>
    <app-recovery-plan [recoveryPlan]="generatedPlan"></app-recovery-plan>
    <div style="text-align: end; margin-top: 16px;">
      <button mat-button matStepperPrevious>Anterior</button>
      <button mat-flat-button color="primary" (click)="save()" style="margin-left: 8px;">
        Guardar
      </button>
    </div>
  </mat-step>
</mat-stepper>